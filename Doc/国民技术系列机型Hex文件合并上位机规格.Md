# 国民技术系列机型Hex文件合并上位机规格

## 上位机要求主要分为三部分
 1. 上位机能够通过INI文件配置满足不同机型的合并要求，即INI文件配置
 2. 上位机能够通过Inter协议读取两份Hex文件并将其合并为满足Inter协议的Hex文件，即Hex文件合并
 3. 上位机能够对合并的Hex文件某部分内容转换为Bin文件，通过指定校验算法将Bin文件校验和写入到Bin文件的指定位置，即Hex文件转换为Bin文件

## INI文件配置要求
 1. 源文件1文件名
 2. 源文件1起始地址
 3. 源文件1结束地址
 4. 源文件2文件名
 5. 源文件2起始地址
 6. 源文件2结束地址
 7. 合并文件文件名
 8. 合并文件起始地址
 9. 合并文件结束地址
 10. 合并文件校验和地址
 11. 合并文件行字符数
 12. Bin文件起始地址
 13. Bin文件结束地址
 14. Bin文件校验和地址
 15. Bin文件行字符数

 注意事项： 
 1. Bin文件起始地址是合并文件的地址，即合并文件的某段地址开始转换为Bin文件
 2. Bin文件校验和以及合并文件校验和内容一致，校验和按照低位在前，高位在后的格式填入文件指定位置
 3. 合并文件行字符数以及Bin文件行字符数代表可以选择设定Hex以及Bin文件每一行加载数据的长度

## Hex文件合并
### Inter规格

 [Intel Hex Format](http://www.interlog.com/~speff/usefulinfo/Hexfrmt.pdf)

### 了解Hex文件结构

1.Hex文件通用格式：

```
:020000040801F1
```

|  RECORD MARK | LOAD RECLEN | OFFSET | RECTYP | INFO Or DATA | CHKSUM |
|  :-:   | :-:   |  :-:    | :-:     | :-:   | :-:    |
| :   | 02  |  0000   | 04     | 0801     |  F1    |

Record Type:
<!-- - '00' Data Record
- '01' End of File Record
- '02' Extended Segment Address Record
- '03' Start Segment Address Record
- '04' Extended Linear Address Record
- '05' Start Linear Address Record -->

- '00’Data Rrecord：用来记录数据，HEX文件的大部分记录都是数据记录
- '01’文件结束记录：用来标识文件结束，放在文件的最后，标识HEX文件的结尾
- '02’扩展段地址记录：用来标识扩展段地址的记录
- '03’开始段地址记录：开始段地址记录
- '04’扩展线性地址记录：用来标识扩展线性地址的记录
- '05’开始线性地址记录：开始线性地址记录

本规格仅用到'00''01''04''05'这几种类型

### 获取合并文件的必要内容

```
:1000B0000000000000000000000000000000000040
:1000C0000000000000000000000000000000000030
:1001000000900020956C0108D5660108D7660108AB
:1001100000000000000000000000000000000000DF
:10012000000000000000000000000000D966010887
```

如上述的内容所示,Hex文件中类型为'00'的数据记录存在Offset从'0C00'偏移到'0100'的情况，此时合并的Hex文件应当补充完整缺失的部分内容。'00'为Hex文件的数据记录类型

```
:020000040801F1
```
如上述的内容所示,Hex文件中类型为'04'的数据表示之后的数据记录从0x8010000开始累加

```
:0400000508016C95ED
```
如上述的内容所示,Hex文件中类型为'05'的数据表示该Hex文件执行的起始地址为0x08016C95

```
:00000001FF
```
如上述的内容所示,Hex文件中类型为'01'的数据表示该Hex文件已到文件末端

合并文件主要使用到'00'数据/'04'地址偏移/'01'标记Hex文件末端

### Hex文件校验和算法

```
:1001000000900020956C0108D5660108D7660108AB
```
计算0xAB前所有16进制数的累加和，不计进位（即：低位单字节），检验和 = 0x100 - 累加和 。如上例，B6之前的所有16进制累加和为0x0455，取低位单字节位0x55，则校验和 = 0x100 - 0x55 = 0xAB

### 注意事项

```
:020000042000DA
:10000000000000000000000055551111AAAAFF00D1
```
如上述的内容所示,Hex文件中类型为'04'的数据表示之后的数据记录从0x20000000开始累加,注意地址是否属于合并文件起始地址以及合并文件结束地址范围之内，若不属于之后的数据应该被抛弃

## Hex文件转换为Bin文件

### 转换为Bin文件的参考步骤
 
 1. 将指定地址的Hex数据使用文件流读取出来并按照Hex文件格式将其中的数据解析处理（即Bin文件仅需'00'的数据记录）
 2. Hex文件数据解析出来后，将每两个ASCII组合成一个十六进制字符串转换为十六进制数
 3. 将所有需要写入的十六进制数用文件流的形式写入文件中并使用指定校验算法计算其校验值，将校验值写入到指定位置

 ### Bin文件校验算法

 参考代码
 ```
 UINT16 LIB_u16UpdateCRC16 (UINT16 u16LastCrc,UINT8* pValueArray,Uint32 u32Length)
{
    WORD u16Tmp;

    u16Tmp = u16LastCrc;

    for (Uint32 i = 0; i < u32Length; i++)
    {
        u16Tmp ^= (Uint16)*(pValueArray + i);

        for(BYTE j=0; j<8; j++)
        {
            if((u16Tmp & 0x0001) != 0)
            {
                u16Tmp >>= 1;
                u16Tmp ^= 0xA001;
            }
            else
            {
                u16Tmp >>= 1;
            }   
        }
    }
   
    return u16Tmp;
}
 ```
